C51 COMPILER V9.60.7.0   EVENT                                                             07/04/2024 19:58:40 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE EVENT
OBJECT MODULE PLACED IN .\Objects\event.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE event.c LARGE WARNINGLEVEL(1) OPTIMIZE(9,SIZE) BROWSE DEBUG OBJECTEXTEND
                    - PRINT(.\Listings\event.lst) TABS(2) OBJECT(.\Objects\event.obj)

line level    source

   1          #include "event.h"
   2          #include "ds1302.h"
   3          #include "keyscan.h"
   4          #include "alarm.h"
   5          #include "delay.h"
   6          #include "bmp.h"
   7          
   8          Date today;
   9          Event event;
  10          uchar redraw = 0, event_about_to_happen_original = 0, event_about_to_happen_new = 0, event_status_temp = 0
             -;
  11          
  12          void event_init(){
  13   1        event.year = 0;
  14   1        event.month = 1;
  15   1        event.day = 2;
  16   1        event.year_of_last_day = 0;
  17   1        event.month_of_last_day = 1;
  18   1        event.day_of_last_day = 1;
  19   1        event.status = 0;
  20   1      }
  21          
  22          Date date_addition_adjust(uint year_num, char month_num, char day_num){
  23   1        Date correct_date;
  24   1        day_num = adjust_30(year_num, month_num, day_num, 0);
  25   1        if(day_num == 1) month_num++;
  26   1        if (month_num > 12) {
  27   2          month_num = 1;
  28   2          year_num++;
  29   2        }
  30   1        correct_date.year = year_num;
  31   1        correct_date.month = month_num;
  32   1        correct_date.day = day_num;
  33   1        return correct_date;
  34   1      }
  35          
  36          Date date_subtraction_adjust(uint year_num, char month_num, char day_num){
  37   1        Date correct_date;
  38   1        if(day_num < 1) month_num--;
  39   1        if(month_num < 1){
  40   2          year_num--;
  41   2          month_num = 12;
  42   2        }
  43   1        if(day_num < 1) day_num = adjust_30(year_num, month_num, 32, 1);
  44   1        correct_date.year = year_num;
  45   1        correct_date.month = month_num;
  46   1        correct_date.day = day_num;
  47   1        return correct_date;
  48   1      }
  49          
  50          uchar is_event_about_to_happen(){
  51   1        today.year = get_integer_year();
  52   1        today.month = get_integer_month();
  53   1        today.day = get_integer_day();
C51 COMPILER V9.60.7.0   EVENT                                                             07/04/2024 19:58:40 PAGE 2   

  54   1        if(today.year == event.year && today.month == event.month && today.day == event.day) return 1;
  55   1        if(event.status == 2 && today.year == event.year_of_last_day && today.month == event.month_of_last_day &&
             - today.day == event.day_of_last_day) return 1;
  56   1        return 0;
  57   1      }
  58          
  59          void set_event_control(uint year, char month, char day, uchar status){
  60   1        Date last_day;
  61   1        event.year = year;
  62   1        event.month = month;
  63   1        event.day = day;
  64   1        event.status = status;
  65   1        last_day = date_subtraction_adjust(event.year, event.month, event.day - 1);
  66   1        event.year_of_last_day = last_day.year;
  67   1        event.month_of_last_day = last_day.month;
  68   1        event.day_of_last_day = last_day.day;
  69   1        event_status_temp = event.status;
  70   1      }
  71          
  72          void set_event_content(char content[20]){
  73   1        uchar i;
  74   1        for(i=0;content[i]!=0 && i<16;i++) event.content[i] = content[i];
  75   1        if(i<16) event.content[i] = 0;
  76   1        else event.content[16] = 0;
  77   1        redraw = 1;
  78   1      }
  79          
  80          void event_tick_tock(uchar x, uchar y){
  81   1        event_about_to_happen_new = is_event_about_to_happen();
  82   1        if(event_about_to_happen_new != event_about_to_happen_original){
  83   2          redraw = 1;
  84   2          event_about_to_happen_original = event_about_to_happen_new;
  85   2        }
  86   1        if(redraw){
  87   2          OLED_ShowString(x,y,"                ",16);
  88   2          redraw = 0;
  89   2        }
  90   1        if(event.status && event_about_to_happen_new){
  91   2          OLED_ShowString(x,y,event.content,16);
  92   2        }
  93   1        else{
  94   2          print_lunar_and_term_now(12, y);
  95   2        }
  96   1      }
  97          
  98          void page_event_null(){
  99   1        char ble_add_chinese[] = {43,48,49,50,51,72,73}, no_event_chinese[] = {71,29,30,69,70}, press_key_cancel_
             -chinese[] = {58,59,60,61,62,63};
 100   1        OLED_Clear();
 101   1        OLED_ShowChineseString(24,0,0,no_event_chinese,5);
 102   1        OLED_ShowChineseString(8,2,0,ble_add_chinese,7);
 103   1        OLED_ShowChineseString(16,6,0,press_key_cancel_chinese,6);
 104   1        while(1){
 105   2          if(event.year || getKey()){
 106   3            OLED_Clear();
 107   3            break;
 108   3          }
 109   2        }
 110   1      }
 111          
 112          void page_event_view(){
 113   1        char remind_chinese[] = {29,30}, only_same_chinese[] = {80,79,4}, same_and_in_advance_chinese[] = {79,4,2
C51 COMPILER V9.60.7.0   EVENT                                                             07/04/2024 19:58:40 PAGE 3   

             -3,29,76,77,4};
 114   1        char saved_chinese[] = {29,30,13,14,15}, if_sure_to_clear_chinese[] = {81,36,82,83,69,70,84}, cancel_chin
             -ese[] = {85,86}, sure_chinese[] = {81,36};
 115   1        uchar weekday_char[2] = {16, 15};
 116   1        event_status_temp = event.status;
 117   1        OLED_Clear();
 118   1        while(1){
 119   2          if(!event.year){
 120   3            page_event_null();
 121   3            if(!event.year) return;
 122   3          }
 123   2          if(redraw){
 124   3            OLED_Clear();
 125   3            redraw = 0;
 126   3          }
 127   2          OLED_ShowString(0,0,event.content,16);
 128   2          print_date_any_time(0, 2, event.year, event.month, event.day);
 129   2          OLED_ShowChineseString(0,4,0,remind_chinese,2);
 130   2          OLED_ShowChar(32,4,':',16);
 131   2          if(event_status_temp == 0) OLED_ShowChinese_Reverse(48,4,0,71);
 132   2          else OLED_ShowChinese(48,4,0,71);
 133   2          if(event_status_temp == 1) OLED_ShowChineseString_Reverse(80,4,0,only_same_chinese,3);
 134   2          else OLED_ShowChineseString(80,4,0,only_same_chinese,3);
 135   2          if(event_status_temp == 2) OLED_ShowChineseString_Reverse(8,6,0,same_and_in_advance_chinese,7);
 136   2          else OLED_ShowChineseString(8,6,0,same_and_in_advance_chinese,7);
 137   2          if(getKey() == 1){
 138   3            OLED_Clear();
 139   3            OLED_ShowChineseString(8,2,0,if_sure_to_clear_chinese,7);
 140   3            OLED_ShowChineseString(0,6,0,cancel_chinese,2);
 141   3            OLED_ShowChineseString(48,6,0,sure_chinese,2);
 142   3            while(1){
 143   4              if(getKey() == 3) break;
 144   4              else if(getKey() == 4){
 145   5                event_init();
 146   5                break;
 147   5              }
 148   4            }
 149   3            OLED_Clear();
 150   3          }
 151   2          else if(getKey() == 2){
 152   3            event_status_temp++;
 153   3            if(event_status_temp > 2) event_status_temp = 0;
 154   3          }
 155   2          else if(getKey() == 3){
 156   3            OLED_Clear();
 157   3            break;
 158   3          }
 159   2          else if(getKey() == 4){
 160   3            OLED_Clear();
 161   3            event.status = event_status_temp;
 162   3            OLED_DrawBMP(0, 0, 128, 4, success_icon);
 163   3            OLED_ShowChineseString(24,4,0,saved_chinese,5);
 164   3      //      OLED_ShowString(32,2,"Saved!",16);
 165   3            delay_ms(2000);
 166   3            OLED_Clear();
 167   3            break;
 168   3          }
 169   2        }
 170   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
C51 COMPILER V9.60.7.0   EVENT                                                             07/04/2024 19:58:40 PAGE 4   

   CODE SIZE        =   1372    ----
   CONSTANT SIZE    =     65    ----
   XDATA SIZE       =     37      76
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
